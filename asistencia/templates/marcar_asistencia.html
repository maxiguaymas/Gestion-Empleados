{% extends 'base.html' %}

{% block content %}
<main class="py-5 d-flex align-items-center justify-content-center" id="empleados">
    <div class="container text-center">
        <div class="card shadow fondo-semi mx-auto" style="max-width: 700px;">
            <div class="card-header">
                <h2 class="card-title mb-0">Marcar Asistencia</h2>
            </div>
            <div class="card-body">
                <p>Por favor, ubique su rostro frente a la cámara.</p>
                <div class="camera-container border rounded bg-dark mx-auto" style="width: 100%; max-width: 500px;">
                    <video id="video" width="100%" height="auto" autoplay></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <div id="status" class="mt-3 fs-5">
                    <span class="badge bg-secondary">Esperando rostro...</span>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusDiv = document.getElementById('status');
    let processing = false;

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("Error al acceder a la cámara: ", err);
            statusDiv.innerHTML = `<span class="badge bg-danger">Error de cámara</span>`;
        });

    const recognizeFace = () => {
        if (processing) return;
        processing = true;

        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/jpeg');

        const formData = new FormData();
        formData.append('image', imageData);

        fetch("{% url 'api_reconocer_rostro' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusDiv.innerHTML = `<span class="badge bg-success">¡Asistencia registrada para ${data.nombre}!</span>`;
            } else if (data.status === 'already_marked') {
                statusDiv.innerHTML = `<span class="badge bg-warning"> ${data.nombre}, ya has marcado asistencia hoy.</span>`;
            }
            processing = false; // Liberar para el siguiente intento
        })
        .catch(() => {
            processing = false;
        });
    };

    // Intentar reconocer cada 2 segundos
    const intervalId = setInterval(recognizeFace, 2000);
});
</script>
{% endblock %}